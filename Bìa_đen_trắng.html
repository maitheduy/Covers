<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√¨nh T√πy Ch·ªânh B√¨a S√°ch A4</title>
    
    <!-- T√≠ch h·ª£p MathJax -->
    <script>
        MathJax = {
          tex: { inlineMath: [['$', '$']], displayMath: [['$$', '$$']] },
          svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Quicksand:wght@300..700&display=swap');

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            font-family: 'Quicksand', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 20px;
            gap: 30px;
        }

        /* KHU V·ª∞C ƒêI·ªÄU KHI·ªÇN */
        .controls {
            width: 320px;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 50px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .controls h3 {
            text-align: center;
            margin-bottom: 10px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .control-group {
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 6px;
            background-color: #fafafa;
        }

        .control-group h4 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #444;
        }

        .control-btn, .text-input, .color-input, .range-input {
            width: 100%;
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            margin: 5px 0;
        }

        .control-btn {
            padding: 12px 15px;
            font-size: 16px;
            font-weight: 600;
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }

        .control-btn:hover {
            background-color: #357abd;
        }
        
        .control-btn:active {
            transform: scale(0.98);
        }
        
        /* N√öT DONE M·ªöI */
        .finalize-btn {
            background-color: #28a745; /* M√†u xanh l√° */
            margin-top: 10px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        .finalize-btn:hover {
            background-color: #218838;
        }
        
        #imageUpload {
            display: none;
        }

        /* KHU V·ª∞C B√åA S√ÅCH */
        .book-container {
             transform: scale(0.75);
             transform-origin: top center;
             margin-top: 20px;
        }
        
        .book-cover {
            width: 794px;
            height: 1123px;
            background-image: url('https://images.unsplash.com/photo-1562763563-4735e070a2ea?q=80&w=1974&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 60px;
            box-sizing: border-box;
            box-shadow: 0 15px 40px rgba(0,0,0,0.5);
            text-align: center;
            color: white;
            position: relative;
            isolation: isolate;
            overflow: hidden;
        }
        
        .book-cover::before {
            content: '';
            position: absolute;
            inset: 0;
            background-color: rgba(0, 30, 10, 0.5);
            z-index: -1;
        }

        .header, .footer {
            width: 100%;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .formula-container {
             width: 100%;
             z-index: 1;
             margin: 40px 0;
        }
        
        .title, .author, .publisher {
            position: relative;
            cursor: default;
            transition: border 0.2s ease;
            border: 2px dashed transparent;
            user-select: none;
        }
        
        .is-draggable {
            cursor: move !important;
            border-color: rgba(255, 255, 255, 0.7) !important;
            padding: 5px;
        }

        .title {
            font-family: 'Playfair Display', serif;
            font-size: 6rem;
            font-weight: 800;
            text-shadow: 3px 3px 10px rgba(0,0,0,0.6);
            margin-bottom: 20px;
            position: relative;
        }

        .author {
            font-family: 'Playfair Display', serif;
            font-style: italic;
            font-size: 2.2rem;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.5);
        }

        #math-formula {
            font-size: 2.75em;
            color: #f0f0f0;
            text-shadow:
                -0.5px -0.5px 1px rgba(255, 255, 255, 0.4),
                0.5px 0.5px 0px #b2b2b2, 1px 1px 0px #a0a0a0,
                1.5px 1.5px 0px #8e8e8e, 2px 2px 0px #7c7c7c,
                2.5px 2.5px 0px #6a6a6a, 4px 6px 15px rgba(0, 0, 0, 0.45);
        }

        .footer {
            border-top: 1px solid rgba(255, 255, 255, 0.5);
            padding-top: 20px;
        }

        .publisher {
            font-family: 'Quicksand', sans-serif;
            font-size: 1.4rem;
            font-weight: 600;
            letter-spacing: 0.3em;
            text-transform: uppercase;
        }

        /* Hi·ªáu ·ª©ng hover cho n√∫t ƒëi·ªÅu khi·ªÉn */
        .control-btn.secondary {
            background-color: #6c757d;
        }
        .control-btn.secondary:hover {
            background-color: #5a6268;
        }

        /* Nh√≥m n√∫t toggle */
        .toggle-group {
            display: flex;
            gap: 5px;
        }
        .toggle-btn {
            flex: 1;
            padding: 8px;
            font-size: 13px;
        }
        .toggle-btn.active {
            background-color: #007bff;
            color: white;
        }

    </style>
</head>
<body>

    <!-- B·∫¢NG ƒêI·ªÄU KHI·ªÇN -->
    <div class="controls">
        <h3>üéõÔ∏è T√ôY CH·ªàNH B√åA S√ÅCH</h3>
        
        <!-- ·∫¢NH N·ªÄN -->
        <div class="control-group">
            <h4>üñºÔ∏è ·∫¢nh n·ªÅn b√¨a</h4>
            <button class="control-btn" id="uploadBtn">T·∫£i ·∫£nh n·ªÅn m·ªõi</button>
            <input type="file" id="imageUpload" accept="image/*">
            <input type="range" class="range-input" id="bgOpacity" min="0" max="1" step="0.1" value="0.5">
            <label>ƒê·ªô m·ªù l·ªõp ph·ªß: <span id="bgOpacityVal">0.5</span></label>
        </div>

        <!-- TI√äU ƒê·ªÄ S√ÅCH -->
        <div class="control-group">
            <h4>üìö T√™n s√°ch</h4>
            <input type="text" class="text-input" id="titleText" placeholder="Nh·∫≠p t√™n s√°ch" value="C√¢y Tre V√¥ T·∫≠n ƒê·ªët">
            <input type="color" class="color-input" id="titleColor" value="#ffffff">
            <select id="titleFont">
                <option value="'Playfair Display', serif">Playfair Display</option>
                <option value="'Quicksand', sans-serif">Quicksand</option>
                <option value="Arial, sans-serif">Arial</option>
                <option value="'Times New Roman', serif">Times New Roman</option>
            </select>
            <input type="range" class="range-input" id="titleSize" min="2" max="10" step="0.5" value="6">
            <label>K√≠ch th∆∞·ªõc: <span id="titleSizeVal">6rem</span></label>
            <button class="control-btn" data-target="#bookTitle">Di chuy·ªÉn v·ªã tr√≠</button>
        </div>

        <!-- T√ÅC GI·∫¢ -->
        <div class="control-group">
            <h4>‚úçÔ∏è T√°c gi·∫£</h4>
            <input type="text" class="text-input" id="authorText" placeholder="Nh·∫≠p t√™n t√°c gi·∫£" value="Mai Th·∫ø Duy">
            <input type="color" class="color-input" id="authorColor" value="#ffffff">
            <select id="authorFont">
                <option value="'Playfair Display', serif">Playfair Display</option>
                <option value="'Quicksand', sans-serif">Quicksand</option>
                <option value="Arial, sans-serif">Arial</option>
            </select>
            <input type="range" class="range-input" id="authorSize" min="1" max="4" step="0.2" value="2.2">
            <label>K√≠ch th∆∞·ªõc: <span id="authorSizeVal">2.2rem</span></label>
            <button class="control-btn" data-target="#authorName">Di chuy·ªÉn v·ªã tr√≠</button>
        </div>

        <!-- NH√Ä XU·∫§T B·∫¢N -->
        <div class="control-group">
            <h4>üè¢ Nh√† xu·∫•t b·∫£n</h4>
            <input type="text" class="text-input" id="publisherText" placeholder="Nh·∫≠p t√™n NXB" value="Nh√† Xu·∫•t B·∫£n ƒê·ª©c Long">
            <input type="color" class="color-input" id="publisherColor" value="#ffffff">
            <select id="publisherFont">
                <option value="'Quicksand', sans-serif">Quicksand</option>
                <option value="'Playfair Display', serif">Playfair Display</option>
                <option value="Arial, sans-serif">Arial</option>
            </select>
            <input type="range" class="range-input" id="publisherSize" min="0.8" max="3" step="0.1" value="1.4">
            <label>K√≠ch th∆∞·ªõc: <span id="publisherSizeVal">1.4rem</span></label>
            <button class="control-btn" data-target="#publisherInfo">Di chuy·ªÉn v·ªã tr√≠</button>
        </div>

        <!-- C√îNG TH·ª®C TO√ÅN -->
        <div class="control-group">
            <h4>üßÆ C√¥ng th·ª©c to√°n</h4>
            <textarea class="text-input" id="formulaText" rows="3" placeholder="Nh·∫≠p c√¥ng th·ª©c LaTeX (d√πng $$...$$)">$$ \int_{\text{g·ªëc}}^{\text{ng·ªçn}} d(\text{tre}) = \text{ng·ªçn} - \text{g·ªëc} $$</textarea>
            <input type="color" class="color-input" id="formulaColor" value="#f0f0f0">
            <input type="range" class="range-input" id="formulaSize" min="1" max="5" step="0.25" value="2.75">
            <label>K√≠ch th∆∞·ªõc: <span id="formulaSizeVal">2.75em</span></label>
            <button class="control-btn" id="updateFormula">C·∫≠p nh·∫≠t c√¥ng th·ª©c</button>
        </div>

        <!-- N√öT HO√ÄN T·∫§T -->
        <button class="control-btn finalize-btn" id="finalizeBtn">‚úì Ho√†n t·∫•t (Done)</button>
    </div>

    <!-- B√åA S√ÅCH -->
    <div class="book-container">
        <div class="book-cover" id="bookCover">
            <div class="header">
                <h1 class="title" id="bookTitle">C√¢y Tre V√¥ T·∫≠n ƒê·ªët</h1>
                <p class="author" id="authorName">Mai Th·∫ø Duy</p>
            </div>
            
            <div class="formula-container">
                <div id="math-formula">
                    $$ \int_{\text{g·ªëc}}^{\text{ng·ªçn}} d(\text{tre}) = \text{ng·ªçn} - \text{g·ªëc} $$
                </div>
            </div>
            
            <div class="footer">
                <p class="publisher" id="publisherInfo">Nh√† Xu·∫•t B·∫£n ƒê·ª©c Long</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const bookCover = document.getElementById('bookCover');
            const uploadBtn = document.getElementById('uploadBtn');
            const imageUpload = document.getElementById('imageUpload');
            
            // --- BI·∫æN TO√ÄN C·ª§C ---
            let currentDraggable = null;
            let isDragging = false;
            let startX, startY, initialLeft, initialTop;
            let isEditingMode = true;

            // --- H√ÄM TI·ªÜN √çCH ---
            function updateElementStyle(element, property, value) {
                if (element && property) element.style[property] = value;
            }

            function updateTextContent(element, text) {
                if (element) element.textContent = text;
            }

            function updateMathJax() {
                if (window.MathJax) {
                    MathJax.typesetClear();
                    MathJax.typeset();
                }
            }

            // --- 1. CH·ª®C NƒÇNG ·∫¢NH N·ªÄN ---
            uploadBtn.addEventListener('click', () => imageUpload.click());
            
            imageUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        bookCover.style.backgroundImage = `url('${e.target.result}')`;
                    };
                    reader.readAsDataURL(file);
                }
            });

            // ƒêi·ªÅu ch·ªânh ƒë·ªô m·ªù l·ªõp ph·ªß
            const bgOpacity = document.getElementById('bgOpacity');
            const bgOpacityVal = document.getElementById('bgOpacityVal');
            bgOpacity.addEventListener('input', () => {
                const val = bgOpacity.value;
                bgOpacityVal.textContent = val;
                bookCover.querySelector('::before').style.backgroundColor = `rgba(0, 30, 10, ${val})`;
                // V√¨ ::before kh√¥ng th·ªÉ truy c·∫≠p tr·ª±c ti·∫øp, n√™n ta th√™m class ƒë·ªÉ override
                bookCover.style.setProperty('--overlay-opacity', val);
            });

            // Th√™m CSS variable ƒë·ªÉ h·ªó tr·ª£
            const style = document.createElement('style');
            style.textContent = `
                .book-cover::before {
                    background-color: rgba(0, 30, 10, var(--overlay-opacity, 0.5)) !important;
                }
            `;
            document.head.appendChild(style);

            // --- 2. CH·ª®C NƒÇNG CH·ªàNH S·ª¨A VƒÇN B·∫¢N ---
            const titleText = document.getElementById('titleText');
            const authorText = document.getElementById('authorText');
            const publisherText = document.getElementById('publisherText');

            titleText.addEventListener('input', () => {
                updateTextContent(document.getElementById('bookTitle'), titleText.value);
            });

            authorText.addEventListener('input', () => {
                updateTextContent(document.getElementById('authorName'), authorText.value);
            });

            publisherText.addEventListener('input', () => {
                updateTextContent(document.getElementById('publisherInfo'), publisherText.value);
            });

            // --- 3. CH·ªàNH S·ª¨A M√ÄU S·∫ÆC ---
            const titleColor = document.getElementById('titleColor');
            const authorColor = document.getElementById('authorColor');
            const publisherColor = document.getElementById('publisherColor');
            const formulaColor = document.getElementById('formulaColor');

            titleColor.addEventListener('input', () => {
                updateElementStyle(document.getElementById('bookTitle'), 'color', titleColor.value);
            });

            authorColor.addEventListener('input', () => {
                updateElementStyle(document.getElementById('authorName'), 'color', authorColor.value);
            });

            publisherColor.addEventListener('input', () => {
                updateElementStyle(document.getElementById('publisherInfo'), 'color', publisherColor.value);
            });

            formulaColor.addEventListener('input', () => {
                updateElementStyle(document.getElementById('math-formula'), 'color', formulaColor.value);
            });

            // --- 4. CH·ªàNH S·ª¨A FONT ---
            const titleFont = document.getElementById('titleFont');
            const authorFont = document.getElementById('authorFont');
            const publisherFont = document.getElementById('publisherFont');

            titleFont.addEventListener('change', () => {
                updateElementStyle(document.getElementById('bookTitle'), 'fontFamily', titleFont.value);
            });

            authorFont.addEventListener('change', () => {
                updateElementStyle(document.getElementById('authorName'), 'fontFamily', authorFont.value);
            });

            publisherFont.addEventListener('change', () => {
                updateElementStyle(document.getElementById('publisherInfo'), 'fontFamily', publisherFont.value);
            });

            // --- 5. CH·ªàNH S·ª¨A K√çCH TH∆Ø·ªöC ---
            const titleSize = document.getElementById('titleSize');
            const authorSize = document.getElementById('authorSize');
            const publisherSize = document.getElementById('publisherSize');
            const formulaSize = document.getElementById('formulaSize');

            const titleSizeVal = document.getElementById('titleSizeVal');
            const authorSizeVal = document.getElementById('authorSizeVal');
            const publisherSizeVal = document.getElementById('publisherSizeVal');
            const formulaSizeVal = document.getElementById('formulaSizeVal');

            titleSize.addEventListener('input', () => {
                const val = titleSize.value;
                titleSizeVal.textContent = val + 'rem';
                updateElementStyle(document.getElementById('bookTitle'), 'fontSize', val + 'rem');
            });

            authorSize.addEventListener('input', () => {
                const val = authorSize.value;
                authorSizeVal.textContent = val + 'rem';
                updateElementStyle(document.getElementById('authorName'), 'fontSize', val + 'rem');
            });

            publisherSize.addEventListener('input', () => {
                const val = publisherSize.value;
                publisherSizeVal.textContent = val + 'rem';
                updateElementStyle(document.getElementById('publisherInfo'), 'fontSize', val + 'rem');
            });

            formulaSize.addEventListener('input', () => {
                const val = formulaSize.value;
                formulaSizeVal.textContent = val + 'em';
                updateElementStyle(document.getElementById('math-formula'), 'fontSize', val + 'em');
                setTimeout(updateMathJax, 100); // ƒê·ª£i render xong m·ªõi update MathJax
            });

            // --- 6. C·∫¨P NH·∫¨T C√îNG TH·ª®C TO√ÅN ---
            const formulaText = document.getElementById('formulaText');
            const updateFormulaBtn = document.getElementById('updateFormula');

            updateFormulaBtn.addEventListener('click', () => {
                const formulaDiv = document.getElementById('math-formula');
                formulaDiv.innerHTML = formulaText.value;
                updateMathJax();
            });

            // --- 7. CH·ª®C NƒÇNG DI CHUY·ªÇN PH·∫¶N T·ª¨ ---
            function activateDraggable(element) {
                if (!isEditingMode) return;
                if (currentDraggable) {
                    currentDraggable.classList.remove('is-draggable');
                }
                currentDraggable = element;
                currentDraggable.classList.add('is-draggable');
                // ƒê·∫∑t v·ªã tr√≠ tuy·ªát ƒë·ªëi n·∫øu ch∆∞a c√≥
                if (getComputedStyle(element).position !== 'absolute') {
                    element.style.position = 'absolute';
                    element.style.left = '50%';
                    element.style.top = element.offsetTop + 'px';
                    element.style.transform = 'translateX(-50%)';
                }
            }

            const moveButtons = document.querySelectorAll('.control-btn[data-target]');
            moveButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetElement = document.querySelector(button.dataset.target);
                    if (targetElement) {
                        activateDraggable(targetElement);
                    }
                });
            });

            bookCover.addEventListener('mousedown', (e) => {
                if (isEditingMode && currentDraggable && e.target === currentDraggable) {
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    const rect = currentDraggable.getBoundingClientRect();
                    const containerRect = bookCover.getBoundingClientRect();
                    initialLeft = rect.left - containerRect.left;
                    initialTop = rect.top - containerRect.top;
                    currentDraggable.style.left = initialLeft + 'px';
                    currentDraggable.style.top = initialTop + 'px';
                    currentDraggable.style.margin = '0';
                    currentDraggable.style.transform = 'none';
                }
            });

            bookCover.addEventListener('mousemove', (e) => {
                if (isDragging && currentDraggable) {
                    e.preventDefault();
                    const containerRect = bookCover.getBoundingClientRect();
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    currentDraggable.style.left = (initialLeft + dx) + 'px';
                    currentDraggable.style.top = (initialTop + dy) + 'px';
                }
            });

            const stopDragging = () => { isDragging = false; };
            bookCover.addEventListener('mouseup', stopDragging);
            bookCover.addEventListener('mouseleave', stopDragging);

            // --- 8. CH·ª®C NƒÇNG N√öT DONE ---
            const finalizeBtn = document.getElementById('finalizeBtn');
            const adjustableControls = document.querySelectorAll('.control-group, .control-btn:not(#finalizeBtn)');

            finalizeBtn.addEventListener('click', () => {
                isEditingMode = !isEditingMode;

                if (isEditingMode) {
                    finalizeBtn.textContent = '‚úì Ho√†n t·∫•t (Done)';
                    finalizeBtn.style.backgroundColor = '#28a745';
                    adjustableControls.forEach(el => el.style.display = 'block');
                } else {
                    finalizeBtn.textContent = 'üîß Ch·ªânh s·ª≠a l·∫°i';
                    finalizeBtn.style.backgroundColor = '#6c757d';
                    adjustableControls.forEach(el => el.style.display = 'none');
                    if (currentDraggable) {
                        currentDraggable.classList.remove('is-draggable');
                        currentDraggable = null;
                    }
                }
            });
        });
    </script>

</body>
</html>
